<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Meteor trajectory viewer</title>
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>

    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"
    integrity="sha384-fU3JmTM3BACOkkqkyvCkZsp5gC4snA8QP4b7tOxoRl8duHf6pxMO0g/YlxM4izL3"
    crossorigin=""></script>

    <link rel="stylesheet" href="mystyle.css" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>

    <script src="https://unpkg.com/leaflet.locatecontrol@0.72.0/src/L.Control.Locate.js"
    integrity="sha384-PSVTmppejJh0R+0VYiO5WfFwPwEhGaGi+vAg+amhVMPBgQIEynPFz44Qw/CzyAgA"
    crossorigin=""></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.72.0/dist/L.Control.Locate.min.css"
    integrity="sha384-vPNGCZwbWwO+u7VXCcmLEJRcz/YmtXGdC3LOF8O4/IvddhfpYZI1O0tJszYkbsD2"
    crossorigin="" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
    integrity="sha384-lPzjPsFQL6te2x+VxmV6q1DpRxpRk0tmnl2cpwAO5y04ESyc752tnEWPKDfl1olr"
    crossorigin="" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"
    integrity="sha384-N9K+COcUk7tr9O2uHZVp6jl7ueGhWsT+LUKUhd/VpA0svQrQMGArhY8r/u/Pkwih"
    crossorigin=""></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet" />
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>

    <script>
        var mymap;
        var meteorLayer;
        var selectedMeteorIds = [];
        var jsonData;
        var meteorTable;
        var stationsIndex; // Differs between CAMS and RMS
        var stationLayers = {};

        var stationIcon = L.Icon.extend({
            options: {
                iconUrl: 'marker-icon-2x-blue.png',
                iconSize: [12.5, 20.5],
                iconAnchor: [5, 20.5],
            }
        });

        var selectedStationIcon = L.Icon.extend({
            options: {
                iconUrl: 'marker-icon-2x-red.png',
                iconSize: [12.5, 20.5],
                iconAnchor: [5, 20.5],
            }

        });

        $(function () {
            var holder = document.getElementById('mapid');

            holder.ondragover = function() {
                return false;
            };
            holder.ondragend = function() {
                return false;
            };
            holder.ondrop = function(e) {
                e.preventDefault();

                var file = e.dataTransfer.files[0],
                reader = new FileReader();
                reader.onload = function(event) {
                    var csvData = event.target.result.replace(/\r/g, "");
                    addMeteorsToMap(csvData);
                    panToExtent();
                };
                reader.readAsText(file);

                return false;
            };

            mymap = L.map('mapid', {maxZoom: 12}).setView([52.3, 5], 8);
            var CartoDB_DarkMatter = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors ' +
                             '&copy; <a href="https://carto.com/attributions">CARTO</a>; ' +
                             '&copy; CC-BY 4.0 <a href="https://globalmeteornetwork.org/data/">Global Meteor Network</a>',
                subdomains: 'abcd',
                maxZoom: 18
            });
            CartoDB_DarkMatter.addTo(mymap);
            L.control.locate({drawCircle: false, drawMarker: false, locateOptions: {
                maxZoom: 10
            }}).addTo(mymap);

            meteorLayer = new L.FeatureGroup();
            meteorLayer.addTo(mymap);

            stationsLayer = addStationsToMap();
            emptyLayer = new L.FeatureGroup();
            emptyLayer.addTo(mymap);

            var stationLayers = {
                "CAMS cameras": {
                    "Cameras": stationsLayer[0],
                    "Sites": stationsLayer[1]
                },
                "Meteors": {
                    "Meteors": meteorLayer
                }
            };

            L.control.layers({"No cameras": emptyLayer,
                              "CAMS cameras (grouped)": stationsLayer[0],
                              "CAMS stations": stationsLayer[1],
                              "RMS stations": stationsLayer[2]}, {
                "Meteors": meteorLayer
            }).addTo(mymap);

            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            var urlStations = urlParams.get("stations");
            if (urlStations) {
                document.getElementById("stationsFilter").value = urlStations;
            }
            var initialDataset = urlParams.get("data");
            if (!initialDataset) {
                initialDataset = "latest_daily"
            }

            meteorTable = new Tabulator("#meteortable", {
                data: [],
                index: "0",
                columns: getColumnDefinitions(false),
                rowClick:function(e, row) {
                    var meteorId = row.getPosition();
                    selectMeteor(meteorId);
                    var leafletId = jsonData.data[meteorId].leafletId;
                    var selectedFeature = meteorLayer.getLayer(leafletId);
                    mymap.flyTo(selectedFeature.getBounds().getCenter(), 8);
                },
                selectable: 1,
                layout: "fitData",
                layoutColumnsOnNewData:true
            });
            updateFilter();

            $("#stationsFilter").change(updateFilter);
            $("#stationsFilter").keyup(updateFilter);

            populateDropdown();
            getMeteorsFromUrl("https://globalmeteornetwork.org/data/traj_summary_data/daily/traj_summary_" + initialDataset + ".txt");
        });

        function updatePermalink() {
            var permalink = document.getElementById("permalink");
            var datasetdropdown = document.getElementById("datasetDropdown");
            var selecteddatasetindex = datasetdropdown.selectedIndex;

            var stationliststr = document.getElementById("stationsFilter").value;

            var newlink = "?stations=" + stationliststr;

            if (selecteddatasetindex != -1) {
                newlink += "&data=" + datasetdropdown.options[selecteddatasetindex].text;
            }

            permalink.href = newlink;
        }

        function updateFilter() {
            var stationliststr = document.getElementById("stationsFilter").value;
            var stationlist = stationliststr.split(/, */);
            meteorTable.setFilter(customFilter, {stationlist: stationlist});
            updatePermalink();
        }

        function customFilter(data, filterParams){
            var leafletId = data.leafletId;
            var selectedFeature = meteorLayer.getLayer(leafletId);
            if (filterParams.stationlist[0]==[""]) {
                L.DomUtil.removeClass(selectedFeature._path, 'filteredout-meteor');
                return true;
            } else {
                // rowstations contains any of the filterparams.stationlist
                var rowstations = data[stationsIndex];
                for (i=0; i<filterParams.stationlist.length; i++) {
                    if (rowstations.includes(filterParams.stationlist[i])) {
                        L.DomUtil.removeClass(selectedFeature._path, 'filteredout-meteor');
                        return true;
                    }
                }
                L.DomUtil.addClass(selectedFeature._path, 'filteredout-meteor');
                return false;
            }
        }

        function onclickStation(e) {
            var append = false;
            if (e.originalEvent.ctrlKey || e.originalEvent.metaKey || e.originalEvent.shiftKey) {
                append = true;
            }
            var stationsFilterBox = document.getElementById("stationsFilter");
            if (append) {
                stationsFilterBox.value = stationsFilterBox.value + "," + e.target.feature.properties.id;
            } else {
                stationsFilterBox.value = e.target.feature.properties.id;
            }
            updateFilter();
        }

        function onclickMeteor(e) {
            var clickedMeteorId = e.target.options.meteorId;
            selectMeteor(clickedMeteorId);
        }

        function loadDataFromGMN() {
            var select = document.getElementById("datasetDropdown");
            getMeteorsFromUrl(select.value);
            updatePermalink();
        }

        function selectStations(stations, doSelect) {
            for (var i=0; i<stations.length; i++) {
                if (!(stations[i] in stationLayers)) {
                    // We don't have a feature for this station
                    console.log("No feature found for station " + stations[i]);
                    continue;
                } else {
                    var stationLayer = stationLayers[stations[i]];
                    for (var s=0; s<stationLayer.length; s++) {
                        if (doSelect) {
                            stationLayer[s].setIcon(new selectedStationIcon);
                        } else {
                            stationLayer[s].setIcon(new stationIcon);
                        }
                    }
                }
            }
        }

        function selectMeteor(meteorId) {
            if (true) {
                // Todo: IF NOT CONTROL OR SHIFT PRESSED
                // Deselect all
                for (oldSelectedMeteorIdIndex in selectedMeteorIds) {
                    var oldSelectedMeteorId = selectedMeteorIds[oldSelectedMeteorIdIndex];
                    var selectedFeature = meteorLayer.getLayer(jsonData.data[oldSelectedMeteorId].leafletId);
                    L.DomUtil.removeClass(selectedFeature._path, 'selected-meteor');
                    selectStations(jsonData.data[oldSelectedMeteorId].stations, false);
                }
                selectedMeteorIds = [];
            }

            L.DomUtil.addClass(meteorLayer.getLayer(jsonData.data[meteorId].leafletId)._path, 'selected-meteor');
            selectedMeteorIds.push(meteorId * 1);
            meteorTable.deselectRow();
            meteorTable.selectRow(jsonData.data[meteorId][0]); // The table is indexed by element 0
            selectStations(jsonData.data[meteorId].stations, true);
            meteorTable.getSelectedRows()[0].scrollTo();
        }

        function getMeteorsFromUrl(url) {
            $.getJSON('https://api.allorigins.win/get?url=' + encodeURIComponent(url) + '&callback=?', function (data) {
                var csvData = data.contents.replace(/\r/g, '');
                addMeteorsToMap(csvData);
                panToExtent();
            });
        }

        function populateDropdown() {
            url = "https://globalmeteornetwork.org/data/traj_summary_data/daily/";
            $.getJSON('https://api.allorigins.win/get?url=' + encodeURIComponent(url) + '&callback=?', function (data) {
                var parser = new DOMParser();
                var doc = parser.parseFromString(data.contents, "text/html");
                var docfrag = document.createDocumentFragment();

                for(var i = 1, l=doc.links.length; i<l; i++) {
                    var base_address = "https://globalmeteornetwork.org/data/traj_summary_data/daily/";
                    var filename = base_address + doc.links[i].getAttribute('href');
                    var prettyname = filename.substr(74, filename.length - 78);
                    docfrag.appendChild(new Option(prettyname, filename));
                }

                var select = document.getElementById("datasetDropdown");
                select.appendChild(docfrag);
                select.selectedIndex = select.options.length-2;
            });
        }

        function panToExtent() {
            if (document.getElementById("stationsFilter").value=="") {
                return;
            }
            var tempLayer = new L.FeatureGroup();
            var meteors = meteorLayer.getLayers();
            for (var i=0; i<meteors.length; i++) {
                if (!L.DomUtil.hasClass(meteors[i]._path, 'filteredout-meteor')) {
                    tempLayer.addLayer(meteors[i]);
                }
            }
            if (tempLayer.getLayers().length > 0) {
                mymap.panTo(tempLayer.getBounds().getCenter(), 7);
            }
        }

        function forEachStation(stationFeature, layer) {
            layer.on("click", onclickStation);
            layer.options.title = stationFeature.properties.name + "(" + stationFeature.properties.id + ")";
            //var icon = layer.options.icon;
            //icon.options.iconSize = [12.5, 20.5];
            //icon.options.iconAnchor = [5, 20.5];
            var stationIds = stationFeature.properties.id.split(",");
            for (var stationIdIdx=0; stationIdIdx<stationIds.length; stationIdIdx++) {
                var stationId = stationIds[stationIdIdx];
                if (stationFeature.properties.id in stationLayers) {
                    stationLayers[stationId].push(layer);
                } else {
                    stationLayers[stationId] = [layer];
                }
            }
            layer.setIcon(new stationIcon);
        }

        function addStationsToMap() {
            var camsStationLayer = new L.markerClusterGroup({showCoverageOnHover: false,
                 zoomToBoundsOnClick: false, maxClusterRadius:1});
            $.getJSON("cams-sites.json", function (data) {
                locations = L.geoJson(data, {
                    onEachFeature: forEachStation,
                    pointToLayer: function (feature, latlng) {
                        return L.marker(latlng)
                    }
                });

                locations.addTo(camsStationLayer);
            });

            var camsStationLayerDedup = new L.FeatureGroup();
            $.getJSON("cams-sites-dedup.json", function (data) {
                locations = L.geoJson(data, {
                    onEachFeature: forEachStation,
                    pointToLayer: function (feature, latlng) {
                        return L.marker(latlng)
                    }
                });

                locations.addTo(camsStationLayerDedup);
            });

            var rmsStationLayer = new L.FeatureGroup();
            $.getJSON("rms-sites.json", function (data) {
                locations = L.geoJson(data, {
                    onEachFeature: forEachStation,
                    pointToLayer: function (feature, latlng) {
                        return L.marker(latlng)
                    }
                });

                locations.addTo(rmsStationLayer);
            });

            return [camsStationLayer, camsStationLayerDedup, rmsStationLayer];
        }

        function getColumnDefinitions(isCams) {
            if (isCams) {
                var dateConcatMutator = function(value, data, type, params, component){
                  //value - original value of the cell
                  //data - the data for the row
                  //type - the type of mutation occurring  (data|edit)
                  //params - the mutatorParams object from the column definition
                  //component - when the "type" argument is "edit", this contains the cell component for the edited cell, otherwise it is the column component for the column
                  return data[1] + " " + data[2] ; //return the sum of the other two columns.
                }

                return [
                    {title: "Number", field: "0"},
                    {title: "Start (UTC)", field: "sumcol", mutator: dateConcatMutator},
                    {title:"Vinf (km/s)", hozAlign:"right", field: "9"},
                    {title:"Int-mV (mag)", hozAlign:"right", field: "31"},
                    {title:"Ht_beg (km)", hozAlign:"right", field: "19"},
                    {title:"Ht_end (km)", hozAlign:"right", field: "25"},
                    {title: "Stations", field: "34"}
                ]
            } else {
                return [
                    {title:"Start (UTC)", field:"1"},
                    {title:"V_avg (km/s)", hozAlign:"right", field: "58"},
                    {title:"Ht_beg (km)", hozAlign:"right", field: "64"},
                    {title:"Ht_end (km)", hozAlign:"right", field: "70"},
                    {title:"Duration (s)", hozAlign:"right", field: "72"},
                    {title:"Peak (abs mag)", hozAlign:"right", field: "73"},
                    {title:"Stations", field:"82"}
                    ]
            }
        }

        function addMeteorsToMap(csvData) {
            if ((!csvData.includes(';')) && !(csvData.includes(','))) {
                // Make CAMS format (fixed-width) ;-separated
                csvData = csvData.replace(/  */g, ";");
                csvData = csvData.replace(/^Ver.*/, "");
                csvData = csvData.replace(/Number.*/, "");
                csvData = csvData.replace(/^\n*-----[-;\n]*/, "");
            }
            jsonData = Papa.parse(csvData, {
                comments: "#",
                delimiter: ';',
                dynamicTyping: false,
                skipEmptyLines: true
            });

            if (jsonData.data[0].length == 83) {
                console.log("RMS format detected");
                var lonBegIndex = 62;
                var latBegIndex = 60;
                var lonEndIndex = 68;
                var latEndIndex = 66;
                stationsIndex = 82;
                var isCams = false;
            } else if (jsonData.data[0].length == 35) {
                console.log("CAMS format detected");
                var lonBegIndex = 17;
                var latBegIndex = 15;
                var lonEndIndex = 23;
                var latEndIndex = 21;
                stationsIndex = 34;
                var isCams = true;
            } else {
                console.log("Undetected format, num fields is " + jsonData.data[0].length)
            }

            meteorLayer.eachLayer(function (layer) {
                meteorLayer.removeLayer(layer);
            });
            selectedMeteorIds = [];

            for (meteorIndex in jsonData.data) {
                var lonBeg = jsonData.data[meteorIndex][lonBegIndex];
                var latBeg = jsonData.data[meteorIndex][latBegIndex];
                var lonEnd = jsonData.data[meteorIndex][lonEndIndex];
                var latEnd = jsonData.data[meteorIndex][latEndIndex];
                var stations = jsonData.data[meteorIndex][stationsIndex].replace(/^[_ ]/, "").split(/[,_]/);
                stations.forEach((name, index) => stations[index] = name.replace(/^0*/, ""));
                jsonData.data[meteorIndex].stations = stations;
                meteorFeature = L.polyline([[latBeg, lonBeg], [latEnd, lonEnd]], {className: 'unselected-meteor', meteorId: meteorIndex});
                meteorFeature.addTo(meteorLayer);
                meteorFeature.on("click", onclickMeteor);
                jsonData.data[meteorIndex].leafletId = meteorLayer.getLayerId(meteorFeature);
            }

            meteorTable.setColumns(getColumnDefinitions(isCams));
            meteorTable.setData(jsonData.data);
        }
    </script>
</head>

<body>

    <h1>Meteor trajectory viewer</h1>
    <svg height="0" width="0" version="1.1" xmlns="http://www.w3.org/2000/svg" style="height:0; position:absolute; width:0">
        <defs>
          <linearGradient id="GradientUnselected">
            <stop offset="5%" stop-color="#FFFFF0" />
            <stop offset="95%" stop-color="#857f32" />
          </linearGradient>
          <linearGradient id="GradientSelected">
            <stop offset="5%" stop-color="#FFF" />
            <stop offset="95%" stop-color="#DB2721" />
          </linearGradient>
          <linearGradient id="GradientFilteredOut">
            <stop offset="5%" stop-color="#888" />
            <stop offset="95%" stop-color="#333" />
          </linearGradient>
        </defs>
      </svg>

    <p>Drag a SummaryMeteorLog file or a traj_summary file onto the map to view them. Or click below to load meteors
        from the Global Meteor Network. The data from the <a href="https://globalmeteornetwork.org/data/">Global Meteor
            Network</a> is used under a CC-BY 4.0 license.
        The maps on this website are therefore also licensed CC-BY 4.0.
    </p>
    <p>Link for the current selection: <a id="permalink" href="?data=latest_daily&stations=">here</a>.</p>

    <select id="datasetDropdown" onChange="loadDataFromGMN()"></select>
    <br />
    <br />
    <div id="mapid"></div>
    <br />
    Filter stations: <input type="text" id="stationsFilter"></input>
    <div id="meteortable"></div>
</body>
</html>
